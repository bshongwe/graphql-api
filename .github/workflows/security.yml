name: Dependency & Security Monitoring

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # ============================================
  # Dependency Updates
  # ============================================
  dependency-review:
    name: Dependency Security Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check for outdated dependencies
        run: npm outdated || true

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: audit
        continue-on-error: true
        run: |
          # Run npm audit and capture output
          npm audit --json > audit-results.json 2>&1 || true
          
          # Ensure file exists
          if [ ! -f audit-results.json ]; then
            echo '{"metadata":{"vulnerabilities":{"critical":0,"high":0}}}' > audit-results.json
          fi
          
          # Display results
          echo "=== Audit Results ==="
          cat audit-results.json | jq -r '.metadata.vulnerabilities' 2>/dev/null || echo "No vulnerability data"

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: npm-audit-results
          path: audit-results.json

      - name: Analyze vulnerabilities
        continue-on-error: true
        run: |
          # Safely extract vulnerability counts
          CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-results.json 2>/dev/null || echo "0")
          HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' audit-results.json 2>/dev/null || echo "0")
          MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' audit-results.json 2>/dev/null || echo "0")
          LOW=$(jq -r '.metadata.vulnerabilities.low // 0' audit-results.json 2>/dev/null || echo "0")
          
          echo "üìä Vulnerability Summary:"
          echo "  Critical: $CRITICAL"
          echo "  High: $HIGH"
          echo "  Moderate: $MODERATE"
          echo "  Low: $LOW"
          
          # Create GitHub annotations (warnings, not errors)
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::warning::‚ö†Ô∏è Found $CRITICAL critical vulnerabilities - review and update dependencies"
          fi
          
          if [ "$HIGH" -gt 5 ]; then
            echo "::warning::‚ö†Ô∏è Found $HIGH high vulnerabilities - consider updating dependencies"
          fi
          
          # Always succeed - this is monitoring, not blocking
          exit 0

  # ============================================
  # Automated Dependency Updates
  # ============================================
  dependabot-auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-approve minor and patch updates
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
          steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge for Dependabot PRs
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
          steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Container Vulnerability Scanning
  # ============================================
  container-scan:
    name: Scan Production Images
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Check if image exists
        id: check-image
        continue-on-error: true
        run: |
          echo "üîç Checking registry for image: ghcr.io/${{ github.repository }}:latest"
          
          # Try to inspect image manifest (doesn't require pulling)
          if docker manifest inspect ghcr.io/${{ github.repository }}:latest > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Image found in registry - proceeding with scan"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Image not found in registry"
            echo "::notice title=Container Scan Skipped::Image not yet published. Container scanning will activate after first successful CI build and push."
          fi

      - name: Run Trivy scan on latest image
        if: steps.check-image.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ghcr.io/${{ github.repository }}:latest
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH'

      - name: Upload scan results
        if: steps.check-image.outputs.exists == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: trivy-scan-results
          path: trivy-results.json

      - name: Check for critical vulnerabilities
        if: steps.check-image.outputs.exists == 'true'
        continue-on-error: true
        run: |
          if [ -f trivy-results.json ]; then
            CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")
            
            echo "üìä Container Vulnerability Summary:"
            echo "  Critical: $CRITICAL"
            echo "  High: $HIGH"
            
            if [ "$CRITICAL" -gt 0 ]; then
              echo "::warning::‚ö†Ô∏è Found $CRITICAL critical vulnerabilities in container image"
            fi
            
            if [ "$HIGH" -gt 10 ]; then
              echo "::warning::‚ö†Ô∏è Found $HIGH high vulnerabilities in container image"
            fi
          fi
      
      - name: Scan summary
        if: steps.check-image.outputs.exists == 'false'
        run: |
          echo "### üì¶ Container Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚è≠Ô∏è Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** Container image not yet published to registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Push code to trigger CI workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. CI will build and push image to ghcr.io" >> $GITHUB_STEP_SUMMARY
          echo "3. Future security scans will automatically scan the image" >> $GITHUB_STEP_SUMMARY
              echo "::warning::Found $CRITICAL critical vulnerabilities in container image"
            fi
          else
            echo "::notice::No scan results available"
          fi

  # ============================================
  # License Compliance Check
  # ============================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: npx license-checker --summary

      - name: Generate license report
        run: |
          npx license-checker --json > licenses.json
          npx license-checker --csv > licenses.csv

      - name: Upload license reports
        uses: actions/upload-artifact@v6
        with:
          name: license-reports
          path: |
            licenses.json
            licenses.csv

  # ============================================
  # Code Quality Monitoring
  # ============================================
  quality-metrics:
    name: Code Quality Metrics
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: SonarCloud Scan
        if: env.SONAR_TOKEN != ''
        uses: SonarSource/sonarcloud-github-action@master
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN || '' }}
        with:
          args: >
            -Dsonar.projectKey=${{ github.repository_owner }}_graphql-api
            -Dsonar.organization=${{ github.repository_owner }}
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.sources=src
            -Dsonar.tests=tests
            -Dsonar.coverage.exclusions=tests/**,**/*.spec.ts

      - name: Check quality gate
        if: env.SONAR_TOKEN != ''
        uses: sonarsource/sonarqube-quality-gate-action@master
        continue-on-error: true
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN || '' }}

  # ============================================
  # Send Notifications
  # ============================================
  notify:
    name: Send Security Notifications
    runs-on: ubuntu-latest
    needs: [dependency-review, container-scan]
    # Only run if a job failed AND webhook is configured
    if: failure() && secrets.SLACK_WEBHOOK_URL != ''
    continue-on-error: true
    
    steps:
      - name: Check Slack configuration
        id: slack-check
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Slack webhook not configured - skipping notification"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Slack webhook configured - will send notification"
          fi
      
      - name: Send Slack alert
        # Double-check: only run if webhook exists
        if: steps.slack-check.outputs.configured == 'true'
        uses: slackapi/slack-github-action@v1.26.0
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {
              "text": "‚ö†Ô∏è Security Alert: GraphQL API",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üîí Security Scan Failed"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Security vulnerabilities detected in GraphQL API"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\nDependency & Security Monitoring"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }
      
      - name: Notification summary
        if: steps.slack-check.outputs.configured == 'false'
        run: |
          echo "### üîî Security Notifications" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚è≠Ô∏è Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** SLACK_WEBHOOK_URL secret not configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To enable Slack notifications:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'gh secret set SLACK_WEBHOOK_URL --body "https://hooks.slack.com/services/..."' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
